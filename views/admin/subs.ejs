<%- include('../partials/header', { title: 'Subs - Admin - Bright Prodigy' }) %>
<div class="layout-grid min-h-screen h-screen">
  <%- include('../partials/sidebar', { user: typeof user !== 'undefined' ? user : null, activeTab: 'subs' }) %>
  <div class="main-content flex-1 flex flex-col min-h-screen h-screen" style="min-width:0;">
    <%- include('../partials/topbar', { user: typeof user !== 'undefined' ? user : null, currentTab: 'Subs' }) %>
    <div class="tab-content w-full max-w-full px-4 flex-1 flex flex-col overflow-hidden">
      <% const tabList = ['All Subs', 'Not Contacted Yet', 'Contacted', 'Waiting Cust Approval', 'Confirmed & Inputted', 'Not Interested after sub', 'Bad Lead', 'Contacted again, no reply', 'Fired']; %>
      <nav class="flex justify-center w-full space-x-2 border-b border-blue-200 mb-6 overflow-x-auto pt-6 items-center" aria-label="Sub stages">
        <!-- Plus Button for Add Sub -->
        <button id="addSubBtn" type="button" class="flex items-center justify-center px-1 py-1 rounded-t-md bg-green-500 hover:bg-green-600 text-white text-base font-bold focus:outline-none focus:ring-2 focus:ring-green-400 mr-2" style="height:28px; width:28px; min-width:0;" title="Add Sub">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 20 20" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 5v10m5-5H5" />
          </svg>
        </button>
        <% tabList.forEach(tab => { %>
          <a
            href="/admin/subs?<%= 'stage=' + encodeURIComponent(tab) %>"
            class="px-3 py-1.5 text-xs font-medium rounded-t-md transition
              <%= currentStage === tab
                ? 'bg-white border-l border-t border-r border-blue-500 text-blue-800 shadow ring-2 ring-blue-500 font-bold'
                : 'bg-blue-50 text-blue-600 hover:bg-blue-100' %>"
            aria-current="<%= currentStage === tab ? 'page' : undefined %>"
          >
            <%= tab %>
          </a>
        <% }) %>
      </nav>
      <div class="content-area flex-1 flex flex-col overflow-hidden">
        <div class="table-container overflow-x-auto overflow-y-auto w-full max-w-full max-h-full border rounded bg-gray-50 p-4">
          <% 
            let displayRows = rows;
            const hasRows = displayRows && displayRows.length > 0; 
          %>
          <table class="table-auto divide-y divide-gray-200 min-w-full">
            <thead class="bg-blue-100 sticky top-0 z-10">
              <tr>
                <% if (hasRows) { Object.keys(displayRows[0]).forEach(col => { %>
                  <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider bg-blue-100 whitespace-nowrap">
                    <%= col %>
                  </th>
                <% }) } %>
              </tr>
            </thead>
            <tbody>
              <% if (hasRows) { %>
                <% displayRows.forEach((row, idx) => { %>
                  <tr class="sub-row <%= idx % 2 === 0 ? 'bg-white' : 'bg-blue-100' %> cursor-pointer hover:bg-blue-200 transition"
                      data-row-index="<%= idx %>">
                    <% Object.values(row).forEach(val => { %>
                      <td class="px-4 py-2 text-sm text-gray-900 whitespace-nowrap"><%= val %></td>
                    <% }) %>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="100" class="text-center py-8 text-gray-400">No submissions found.</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <%- include('../partials/footer') %>
  </div>
</div>

<!-- Add Sub Modal -->
<div id="addSubModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl p-6 relative">
    <button id="closeAddSubModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl font-bold">&times;</button>
    <div id="addSubModalContent"></div>
  </div>
</div>

<!-- Edit Sub Modal -->
<div id="editSubModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl p-6 relative">
    <button id="closeEditSubModal" class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl font-bold">&times;</button>
    <div id="editSubModalContent"></div>
  </div>
</div>

<!-- Expose subsFormOptions to JS ---->
<script>
  window.SUBS_FORM_OPTIONS = <%- JSON.stringify(subsFormOptions) %>;
</script>
<script src="/js/subs.js"></script>
