<% /* The following comment helps linters ignore EJS template syntax. */ %>
<%- include('../partials/header', { title: 'Subs - Admin - Bright Prodigy' }) %>
<div class="layout-grid min-h-screen h-screen">
  <%- include('../partials/sidebar', { user: typeof user !== 'undefined' ? user : null, activeTab: 'subs' }) %>
  <div class="main-content flex-1 flex flex-col min-h-screen h-screen" style="min-width:0;">
    <%- include('../partials/topbar', { user: typeof user !== 'undefined' ? user : null, currentTab: 'Subs' }) %>
    <div class="tab-content w-full max-w-full px-4 flex-1 flex flex-col overflow-hidden">
      <% const tabList = ['Add Sub', 'All Subs', 'Not Contacted Yet', 'Contacted', 'Waiting Cust Approval', 'Confirmed & Inputted', 'Not Interested after sub', 'Bad Lead', 'Contacted again, no reply', 'Fired']; %>
      <nav class="flex justify-center w-full space-x-2 border-b border-blue-200 mb-6 overflow-x-auto pt-6 items-center" aria-label="Sub stages">
        <% tabList.forEach(tab => { %>
          <a
            href="/admin/subs?<%= 'stage=' + encodeURIComponent(tab) %>"
            class="px-3 py-1.5 text-xs font-medium rounded-t-md transition
              <%= currentStage === tab
                ? 'bg-white border-l border-t border-r border-blue-500 text-blue-800 shadow ring-2 ring-blue-500 font-bold'
                : 'bg-blue-50 text-blue-600 hover:bg-blue-100' %>"
            aria-current="<%= currentStage === tab ? 'page' : undefined %>"
          >
            <%= tab %>
          </a>
        <% }) %>
      </nav>
      <% if (currentStage === 'Add Sub') { %>
        <div class="w-full max-w-4xl mx-auto">
          <div class="mb-6">
            <h2 class="text-2xl font-bold text-blue-900">Add Sub</h2>
          </div>
          
          <!-- Material UI Form -->
          <form id="addSubForm" autocomplete="off" class="relative bg-white p-6 rounded-lg shadow w-full">
            
            <!-- Personal Information Section -->
            <div style="margin-bottom: 24px;">
              <h3 style="font-size: 1.25rem; font-weight: 500; color: #1976d2; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0;">
                Personal Information
              </h3>
              
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                <!-- First Name -->
                <div>
                  <label for="firstName" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    First Name <span style="color: #f44336;">*</span>
                  </label>
                  <input
                    type="text"
                    id="firstName"
                    name="First Name"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box;"
                    required
                  />
                  <p id="firstName-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
                
                <!-- Last Name -->
                <div>
                  <label for="lastName" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Last Name <span style="color: #f44336;">*</span>
                  </label>
                  <input
                    type="text"
                    id="lastName"
                    name="Last Name"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box;"
                    required
                  />
                  <p id="lastName-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
                
                <!-- Phone Number -->
                <div>
                  <label for="phoneNumber" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Phone Number <span style="color: #f44336;">*</span>
                  </label>
                  <input
                    type="tel"
                    id="phoneNumber"
                    name="Phone Number"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box;"
                    required
                  />
                  <p id="phoneNumber-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
                
                <!-- Email -->
                <div>
                  <label for="email" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Email
                  </label>
                  <input
                    type="email"
                    id="email"
                    name="Email"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box;"
                  />
                  <p id="email-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
              </div>
            </div>
            
            <!-- Address & Referral Section -->
            <div style="margin-bottom: 24px;">
              <h3 style="font-size: 1.25rem; font-weight: 500; color: #1976d2; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0;">
                Address & Referral
              </h3>
              
              <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 16px; margin-bottom: 16px;">
                <!-- Address -->
                <div>
                  <label for="address" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Address <span style="color: #f44336;">*</span>
                  </label>
                  <input
                    type="text"
                    id="address"
                    name="Address"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box;"
                    required
                  />
                  <p id="address-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
                
                <!-- City -->
                <div>
                  <label for="city" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    City <span style="color: #f44336;">*</span>
                  </label>
                  <input
                    type="text"
                    id="city"
                    name="City"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box;"
                    required
                  />
                  <p id="city-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <!-- Home Stories -->
                <div>
                  <label for="homeStories" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Home Stories <span style="color: #f44336;">*</span>
                  </label>
                  <select
                    id="homeStories"
                    name="Home Stories"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box; background-color: white;"
                    required
                  >
                    <% subsFormOptions.HOME_STORIES.forEach(function(opt) { %>
                      <option value="<%= opt %>"><%= opt %></option>
                    <% }) %>
                  </select>
                  <p id="homeStories-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
                
                <!-- Referral -->
                <div>
                  <label for="referral" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Referral <span style="color: #f44336;">*</span>
                  </label>
                  <select
                    id="referral"
                    name="Referral"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box; background-color: white;"
                    required
                  >
                    <option value="">Select a referral source</option>
                    <% subsFormOptions.REFERRAL_SOURCES.forEach(function(opt) { %>
                      <option value="<%= opt %>"><%= opt %></option>
                    <% }) %>
                  </select>
                  <p id="referral-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
              </div>
            </div>
            
            <!-- Lighting Section -->
            <div style="margin-bottom: 24px;">
              <h3 style="font-size: 1.25rem; font-weight: 500; color: #1976d2; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0;">
                Lighting
              </h3>
              
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 16px;">
                <!-- Lighting Options -->
                <div>
                  <label style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Lighting Options
                  </label>
                  <div style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 12px; background-color: #f5f5f5;">
                    <% subsFormOptions.LIGHTING_OPTIONS.forEach(function(opt) { 
                      var id = `lighting-${opt.replace(/\s+/g, '')}`;
                    %>
                      <div style="margin-bottom: 8px; display: flex; align-items: center;">
                        <input
                          type="checkbox"
                          id="<%= id %>"
                          name="Lighting Options"
                          value="<%= opt %>"
                          style="margin-right: 8px; width: 18px; height: 18px;"
                        />
                        <label for="<%= id %>" style="font-size: 0.875rem;"><%= opt %></label>
                      </div>
                    <% }) %>
                  </div>
                  <p id="addsub-LightingOptions-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
                
                <!-- Lighting Sides -->
                <div>
                  <label style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Lighting Sides
                  </label>
                  <div style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 12px; background-color: #f5f5f5;">
                    <% subsFormOptions.LIGHTING_SIDES.forEach(function(opt) { 
                      var id = `side-${opt.replace(/\s+/g, '')}`;
                    %>
                      <div style="margin-bottom: 8px; display: flex; align-items: center;">
                        <input
                          type="checkbox"
                          id="<%= id %>"
                          name="Lighting Sides"
                          value="<%= opt %>"
                          style="margin-right: 8px; width: 18px; height: 18px;"
                        />
                        <label for="<%= id %>" style="font-size: 0.875rem;"><%= opt %></label>
                      </div>
                    <% }) %>
                  </div>
                  <p id="addsub-LightingSides-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
              </div>
              
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                <!-- Preferred Service Date (Lighting) -->
                <div>
                  <label for="prefServiceDateLighting" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Pref Service Date (LIGHTING)
                  </label>
                  <input
                    type="date"
                    id="prefServiceDateLighting"
                    name="Pref Service Date (LIGHTING)"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box;"
                  />
                  <p id="prefServiceDateLighting-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
                
                <!-- Measure -->
                <div>
                  <label for="measure" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Measure
                  </label>
                  <select
                    id="measure"
                    name="Measure"
                    style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box; background-color: white;"
                  >
                    <% subsFormOptions.MEASURE_OPTIONS.forEach(function(opt) { %>
                      <option value="<%= opt %>"><%= opt %></option>
                    <% }) %>
                  </select>
                  <p id="measure-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
              </div>
              
              <!-- Lighting Notes -->
              <div>
                <label for="lightingNotes" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                  Lighting notes
                </label>
                <textarea
                  id="lightingNotes"
                  name="Lighting notes"
                  rows="3"
                  style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box; resize: vertical;"
                ></textarea>
                <p id="lightingNotes-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
              </div>
            </div>
            
            <!-- Solar Section -->
            <div style="margin-bottom: 24px;">
              <h3 style="font-size: 1.25rem; font-weight: 500; color: #1976d2; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0;">
                Solar
              </h3>
              
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 16px;">
                <!-- Solar Selected Services -->
                <div>
                  <label style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Solar Selected Services
                  </label>
                  <div style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 12px; background-color: #f5f5f5;">
                    <% subsFormOptions.SOLAR_SERVICES.forEach(function(opt) { 
                      var id = `solar-${opt.replace(/\s+/g, '')}`;
                    %>
                      <div style="margin-bottom: 8px; display: flex; align-items: center;">
                        <input
                          type="checkbox"
                          id="<%= id %>"
                          name="Solar Selected Services"
                          value="<%= opt %>"
                          style="margin-right: 8px; width: 18px; height: 18px;"
                        />
                        <label for="<%= id %>" style="font-size: 0.875rem;"><%= opt %></label>
                      </div>
                    <% }) %>
                  </div>
                  <p id="addsub-SolarSelectedServices-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
                
                <div>
                  <div style="margin-bottom: 16px;">
                    <!-- Preferred Service Date (Solar) -->
                    <label for="prefServiceDateSolar" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                      Pref Service Date (SOLAR)
                    </label>
                    <input
                      type="date"
                      id="prefServiceDateSolar"
                      name="Pref Service Date (SOLAR)"
                      style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box;"
                    />
                    <p id="prefServiceDateSolar-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                  </div>
                  
                  <!-- Solar Panels -->
                  <div>
                    <label for="solarPanels" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                      Solar Panels
                    </label>
                    <input
                      type="number"
                      id="solarPanels"
                      name="Solar Panels"
                      style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box;"
                    />
                    <p id="solarPanels-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                  </div>
                </div>
              </div>
              
              <!-- Solar Notes -->
              <div>
                <label for="solarNotes" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                  Solar notes
                </label>
                <textarea
                  id="solarNotes"
                  name="Solar notes"
                  rows="2"
                  style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box; resize: vertical;"
                ></textarea>
                <p id="solarNotes-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
              </div>
            </div>
            
            <!-- Gutter Section -->
            <div style="margin-bottom: 24px;">
              <h3 style="font-size: 1.25rem; font-weight: 500; color: #1976d2; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0;">
                Gutter
              </h3>
              
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 16px;">
                <!-- Gutter Selected Service -->
                <div>
                  <label style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                    Gutter Selected Service
                  </label>
                  <div style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 12px; background-color: #f5f5f5;">
                    <% subsFormOptions.GUTTER_SERVICES.forEach(function(opt) { 
                      var id = `gutter-${opt.replace(/\s+/g, '')}`;
                    %>
                      <div style="margin-bottom: 8px; display: flex; align-items: center;">
                        <input
                          type="checkbox"
                          id="<%= id %>"
                          name="Gutter Selected Service"
                          value="<%= opt %>"
                          style="margin-right: 8px; width: 18px; height: 18px;"
                        />
                        <label for="<%= id %>" style="font-size: 0.875rem;"><%= opt %></label>
                      </div>
                    <% }) %>
                  </div>
                  <p id="addsub-GutterSelectedService-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                </div>
                
                <div>
                  <!-- Preferred Service Date (Gutter) -->
                  <div style="margin-bottom: 16px;">
                    <label for="prefServiceDateGutter" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                      Pref Service Date (GUTTER)
                    </label>
                    <input
                      type="date"
                      id="prefServiceDateGutter"
                      name="Pref Service Date (GUTTER)"
                      style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box;"
                    />
                    <p id="prefServiceDateGutter-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                  </div>
                  
                  <!-- Gutter Notes -->
                  <div>
                    <label for="gutterNotes" style="display: block; font-size: 0.875rem; margin-bottom: 8px; color: rgba(0, 0, 0, 0.6);">
                      Gutter notes
                    </label>
                    <textarea
                      id="gutterNotes"
                      name="Gutter notes"
                      rows="2"
                      style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; transition: border-color 0.2s ease-in-out; box-sizing: border-box; resize: vertical;"
                    ></textarea>
                    <p id="gutterNotes-error" style="color: #f44336; font-size: 0.75rem; margin-top: 3px; display: none;" role="alert"></p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Submit Button -->
            <div style="display: flex; justify-content: flex-end; margin-top: 32px;">
              <button 
                type="submit" 
                style="background-color: #1976d2; color: white; padding: 10px 24px; border-radius: 4px; font-weight: 500; font-size: 0.9375rem; text-transform: uppercase; letter-spacing: 0.02857em; border: none; cursor: pointer; box-shadow: 0px 3px 1px -2px rgba(0,0,0,0.2), 0px 2px 2px 0px rgba(0,0,0,0.14), 0px 1px 5px 0px rgba(0,0,0,0.12); transition: background-color 0.3s;"
                onmouseover="this.style.backgroundColor='#115293'"
                onmouseout="this.style.backgroundColor='#1976d2'"
              >
                Submit
              </button>
            </div>
            
            <!-- Loading Overlay -->
            <div id="addSubLoadingOverlay" class="hidden absolute inset-0 bg-gray-100 bg-opacity-70 flex items-center justify-center" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.7); z-index: 1000;">
              <div style="text-align: center;">
                <div style="width: 40px; height: 40px; border: 4px solid #bbdefb; border-top-color: #1976d2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                <p style="margin-top: 16px; color: #1976d2; font-weight: 500;">Submitting...</p>
              </div>
            </div>
            
            <!-- Success Message -->
            <div id="addSubSuccessMsg" class="hidden" style="display: none; position: absolute; top: 16px; left: 50%; transform: translateX(-50%); background-color: #e8f5e9; color: #2e7d32; padding: 12px 24px; border-radius: 4px; font-weight: 500; box-shadow: 0px 2px 4px -1px rgba(0,0,0,0.2), 0px 4px 5px 0px rgba(0,0,0,0.14), 0px 1px 10px 0px rgba(0,0,0,0.12); z-index: 1100;">
              Submission successful!
            </div>
            
            <style>
              @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
              }
              
              /* Focus states for Material UI look */
              input:focus, select:focus, textarea:focus {
                outline: none;
                border-color: #1976d2;
                box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
              }
              
              /* Error states */
              input[aria-invalid="true"], select[aria-invalid="true"], textarea[aria-invalid="true"] {
                border-color: #f44336 !important;
              }
              
              /* Hover states */
              input:hover:not([disabled]), select:hover:not([disabled]), textarea:hover:not([disabled]) {
                border-color: #666;
              }
            </style>
          </form>
        </div>
        <script src="/js/addSub.js"></script>
      <% } else { %>
        <div class="content-area flex-1 flex flex-col overflow-hidden">
          <div class="table-container overflow-x-auto overflow-y-auto w-full max-w-full max-h-full border rounded bg-gray-50 p-4">
            <% 
              let displayRows = rows;
